<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Kiosk</title>

<style>
  :root{
    --blue:#2563eb; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --bg:#f7f9fc; --panel:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Naskh Arabic UI","Geeza Pro",sans-serif;
    color:var(--ink);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .wrap{
    text-align:center;
    width:100%;
    max-width:600px;
    padding:24px;
  }
  h1{
    font-size:clamp(48px,10vw,100px);
    margin:10px 0 0;
  }
  .sub{
    font-size:clamp(20px,3.5vw,28px);
    color:var(--muted);
    margin-top:10px;
  }
  form{
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top:40px;
  }
  label{font-weight:700;margin-bottom:8px}
  input{
    width:80%;
    padding:14px;
    border:2px solid var(--line);
    border-radius:14px;
    font-size:20px;
    text-align:center;
  }
  input:focus{
    outline:none;
    border-color:#93c5fd;
    box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }
  .btn{
    margin-top:18px;
    background:var(--blue);
    color:#fff;
    border:none;
    border-radius:14px;
    padding:14px 22px;
    font-size:22px;
    font-weight:800;
    cursor:pointer;
  }
  .err{min-height:22px;color:#dc2626;margin-top:10px;font-size:18px}

‎  /* ---------- قالب الطباعة ---------- */
  @media print{
    @page{ size:80mm auto; margin:0 }
    body *{ display:none !important }
    #ticket{
      display:block !important;
      width:72mm;
      margin:0;
      padding:6mm 0;
      text-align:center;
      -webkit-print-color-adjust:exact;
              print-color-adjust:exact;
    }
    #tHeader{font-size:11pt;color:#555;margin-bottom:2mm}
    #tTitle  { font-size:18pt; font-weight:900 }
    #tSub    { font-size:12pt }
    #tNum    { font-size:60pt; font-weight:900; line-height:1 }
    #tMrn    { font-size:18pt; margin:2mm 0 }
    #tWait   { font-size:12pt; margin:2mm 0 }
    #tTs     { font-size:12pt; margin:4px 0 }
    #tLine   { height:2px; background:#000; margin:6px 0 }
    #tThanks { font-size:16pt }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>مرحبًا</h1>
    <div class="sub">فضلاً اكتب رقم الملف (MRN)</div>

    <form id="form">
      <label for="mrn">رقم الملف (MRN)</label>
      <input id="mrn" inputmode="numeric" pattern="[0-9]*" placeholder="MRN" autocomplete="off" />
      <button type="submit" class="btn">طباعة التذكرة / Print Ticket</button>
      <div class="err" id="err"></div>
    </form>

    <div class="next" id="tip">تأكد من اختيار طابعة الرول.</div>
  </div>

‎  <!-- قالب التذكرة (يظهر فقط وقت الطباعة) -->
  <div id="ticket" style="display:none">
    <div id="tHeader">Cardiac Pharmacy Ticket</div>
    <div id="tTitle">مرحبًا</div>
    <div id="tSub">رقم الانتظار</div>
    <div id="tNum">1</div>
    <div id="tMrn">123456</div>
    <div id="tLine"></div>
    <div id="tWait">عدد المنتظرين: 0</div>
    <div id="tTs"></div>
    <div id="tThanks">شكرًا لانتظارك</div>
  </div>

<script>
(function(){
  const ROOT = "cardiac_demo";
  const cfg = {
    apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
    authDomain:"q-matic-b7d77.firebaseapp.com",
    databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
    projectId:"q-matic-b7d77",
    storageBucket:"q-matic-b7d77.appspot.com",
    messagingSenderId:"908187704899",
    appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
  };
  firebase.initializeApp(cfg);
  const db = firebase.database();

  const form = document.getElementById('form');
  const mrnInput = document.getElementById('mrn');
  const err = document.getElementById('err');
  const tNum = document.getElementById('tNum');
  const tMrn = document.getElementById('tMrn');
  const tWait = document.getElementById('tWait');
  const tTs = document.getElementById('tTs');

  let printed = {}, served = {};
  db.ref(`${ROOT}/printed`).on("value", s=>{ printed = s.val()||{}; });
  db.ref(`${ROOT}/served`).on("value", s=>{ served = s.val()||{}; });

  function waitingCount(){
    let c=0;
    for(const k in printed){
      if(printed[k] && !served[k]) c++;
    }
    return c;
  }

  async function getNextNumber(){
    const snap = await db.ref(`${ROOT}/counter`).get();
    let n = (snap.exists()? Number(snap.val()) : 0) + 1;
    if(n>1000) n=1;
    await db.ref(`${ROOT}/counter`).set(n);
    return n;
  }

  function printTicket(num, mrn, wait){
    tNum.textContent = num;
    tMrn.textContent = mrn ? mrn : "";
    tWait.textContent = "عدد المنتظرين: " + String(wait);
    const d = new Date();
    const ts = d.toLocaleString('ar-SA', { hour12:false });
    tTs.textContent = ts;

    const ticket = document.getElementById('ticket');
    ticket.style.display = 'block';
    setTimeout(()=>{ window.print(); }, 30);
    window.onafterprint = ()=>{ ticket.style.display = 'none'; };
  }

  function validMrn(v){
    return /^\d{4,}$/.test(v.trim());
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const mrn = mrnInput.value.trim();
    if(!validMrn(mrn)){
      <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Kiosk</title>

<style>
  :root{
    --blue:#2563eb; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --bg:#f7f9fc; --panel:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Naskh Arabic UI","Geeza Pro",sans-serif;
    color:var(--ink);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .wrap{
    text-align:center;
    width:100%;
    max-width:600px;
    padding:24px;
  }
  h1{
    font-size:clamp(48px,10vw,100px);
    margin:10px 0 0;
  }
  .sub{
    font-size:clamp(20px,3.5vw,28px);
    color:var(--muted);
    margin-top:10px;
  }
  form{
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-top:40px;
  }
  label{font-weight:700;margin-bottom:8px}
  input{
    width:80%;
    padding:14px;
    border:2px solid var(--line);
    border-radius:14px;
    font-size:20px;
    text-align:center;
  }
  input:focus{
    outline:none;
    border-color:#93c5fd;
    box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }
  .btn{
    margin-top:18px;
    background:var(--blue);
    color:#fff;
    border:none;
    border-radius:14px;
    padding:14px 22px;
    font-size:22px;
    font-weight:800;
    cursor:pointer;
  }
  .err{min-height:22px;color:#dc2626;margin-top:10px;font-size:18px}

‎  /* ---------- قالب الطباعة ---------- */
  @media print{
    @page{ size:80mm auto; margin:0 }
    body *{ display:none !important }
    #ticket{
      display:block !important;
      width:72mm;
      margin:0;
      padding:6mm 0;
      text-align:center;
      -webkit-print-color-adjust:exact;
              print-color-adjust:exact;
    }
    #tHeader{font-size:11pt;color:#555;margin-bottom:2mm}
    #tTitle  { font-size:18pt; font-weight:900 }
    #tSub    { font-size:12pt }
    #tNum    { font-size:60pt; font-weight:900; line-height:1 }
    #tMrn    { font-size:18pt; margin:2mm 0 }
    #tWait   { font-size:12pt; margin:2mm 0 }
    #tTs     { font-size:12pt; margin:4px 0 }
    #tLine   { height:2px; background:#000; margin:6px 0 }
    #tThanks { font-size:16pt }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>مرحبًا</h1>
    <div class="sub">فضلاً اكتب رقم الملف (MRN)</div>

    <form id="form">
      <label for="mrn">رقم الملف (MRN)</label>
      <input id="mrn" inputmode="numeric" pattern="[0-9]*" placeholder="MRN" autocomplete="off" />
      <button type="submit" class="btn">طباعة التذكرة / Print Ticket</button>
      <div class="err" id="err"></div>
    </form>

    <div class="next" id="tip">تأكد من اختيار طابعة الرول.</div>
  </div>

‎  <!-- قالب التذكرة (يظهر فقط وقت الطباعة) -->
  <div id="ticket" style="display:none">
    <div id="tHeader">Cardiac Pharmacy Ticket</div>
    <div id="tTitle">مرحبًا</div>
    <div id="tSub">رقم الانتظار</div>
    <div id="tNum">1</div>
    <div id="tMrn">123456</div>
    <div id="tLine"></div>
    <div id="tWait">عدد المنتظرين: 0</div>
    <div id="tTs"></div>
    <div id="tThanks">شكرًا لانتظارك</div>
  </div>

<script>
(function(){
  const ROOT = "cardiac_demo";
  const cfg = {
    apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
    authDomain:"q-matic-b7d77.firebaseapp.com",
    databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
    projectId:"q-matic-b7d77",
    storageBucket:"q-matic-b7d77.appspot.com",
    messagingSenderId:"908187704899",
    appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
  };
  firebase.initializeApp(cfg);
  const db = firebase.database();

  const form = document.getElementById('form');
  const mrnInput = document.getElementById('mrn');
  const err = document.getElementById('err');
  const tNum = document.getElementById('tNum');
  const tMrn = document.getElementById('tMrn');
  const tWait = document.getElementById('tWait');
  const tTs = document.getElementById('tTs');

  let printed = {}, served = {};
  db.ref(`${ROOT}/printed`).on("value", s=>{ printed = s.val()||{}; });
  db.ref(`${ROOT}/served`).on("value", s=>{ served = s.val()||{}; });

  function waitingCount(){
    let c=0;
    for(const k in printed){
      if(printed[k] && !served[k]) c++;
    }
    return c;
  }

  async function getNextNumber(){
    const snap = await db.ref(`${ROOT}/counter`).get();
    let n = (snap.exists()? Number(snap.val()) : 0) + 1;
    if(n>1000) n=1;
    await db.ref(`${ROOT}/counter`).set(n);
    return n;
  }

  function printTicket(num, mrn, wait){
    tNum.textContent = num;
    tMrn.textContent = mrn ? mrn : "";
    tWait.textContent = "عدد المنتظرين: " + String(wait);
    const d = new Date();
    const ts = d.toLocaleString('ar-SA', { hour12:false });
    tTs.textContent = ts;

    const ticket = document.getElementById('ticket');
    ticket.style.display = 'block';
    setTimeout(()=>{ window.print(); }, 30);
    window.onafterprint = ()=>{ ticket.style.display = 'none'; };
  }

  function validMrn(v){
    return /^\d{4,}$/.test(v.trim());
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const mrn = mrnInput.value.trim();
    if(!validMrn(mrn)){
      err.textContent = "فضلاً أدخل رقم الملف بشكل صحيح.";
      mrnInput.focus();
      return;
    }
    err.textContent = "";

    const num = await getNextNumber();
    const updates = {};
    updates[`${ROOT}/printed/${num}`] = true;
    updates[`${ROOT}/mrn/${num}`] = { value: mrn, ts: Date.now() };
    await db.ref().update(updates);

    const wait = waitingCount();
    printTicket(num, mrn, wait);
    mrnInput.value = "";
  });
})();
</script>
</body>
</html>
      mrnInput.focus();
      return;
    }
    err.textContent = "";

    const num = await getNextNumber();
    const updates = {};
    updates[`${ROOT}/printed/${num}`] = true;
    updates[`${ROOT}/mrn/${num}`] = { value: mrn, ts: Date.now() };
    await db.ref().update(updates);

    const wait = waitingCount();
    printTicket(num, mrn, wait);
    mrnInput.value = "";
  });
})();
</script>
</body>
</html>
