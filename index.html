<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Kiosk</title>

<style>
  :root{
    --blue:#2563eb; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --bg:#f6f7fb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Naskh Arabic","Geeza Pro","Tahoma",sans-serif;color:var(--ink)}
  .wrap{margin:auto;min-height:100vh;display:flex;flex-direction:column;justify-content:center;gap:22px;padding:24px;max-width:960px}
  .sub{font-size:clamp(18px,3.6vw,28px);text-align:center;color:var(--muted)}
  h1{font-size:clamp(40px,8.5vw,90px);text-align:center;margin:10px 0 0}
  form{display:flex;flex-direction:column;gap:14px;align-items:center}
  label{font-weight:700}
  input{
    width:100%;max-width:680px;padding:16px 18px;font-size:22px;border:2px solid var(--line);
    border-radius:14px;letter-spacing:1px;text-align:center; /* <-- بالنص */
  }
  input::placeholder{color:#9aa3b2;opacity:.9;text-align:center}
  input:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 4px #dbeafe}
  .btn{background:var(--blue);color:#fff;font-weight:800;border:0;border-radius:14px;padding:14px 26px;font-size:22px;cursor:pointer}
  .next{margin-top:8px;text-align:center;color:var(--muted)}
  .next b{color:#111}
  .err{min-height:22px;color:#dc2626;text-align:center}

  /* قالب الطباعة */
  @media print{
    @page{ size:80mm 90mm; margin:0 }
    body > *{display:none !important}
    #ticket{display:block !important;width:100%;padding:10mm 7mm 8mm 7mm;direction:rtl}
    #tTitle{font-family:Arial,Helvetica,sans-serif;font-size:14pt;font-weight:800;text-align:center;margin-bottom:4mm}
    #tHello{font-size:30pt;text-align:center;margin:0}
    #tSub{font-size:25pt;text-align:center;margin:1mm 0 5mm}
    #tNum{font-size:56pt;line-height:1.0;text-align:center;font-weight:900;margin:0 0 4mm}
    #tMrn{font-size:14pt;text-align:center;margin:0 0 2mm}
    #tWait{font-size:13pt;text-align:center;margin:0 0 4mm}
    #tLine{height:2px;background:#000;margin:3mm 0}
    #tThanks{font-size:20pt;text-align:center;margin:2mm 0 3mm}
    #tTs{font-size:11pt;text-align:center;margin:0}
  }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="sub">Cardiac Pharmacy Ticket</div>
    <h1>مرحبًا</h1>

    <form id="f" autocomplete="off">
      <label for="mrn" class="sub" style="margin-top:6px;"> فضلًا ادخل رقم الملف (MRN)</label>
      
      <input id="mrn" inputmode="numeric" placeholder="MRN" />
      <button class="btn" type="submit">طباعة التذكرة / Print Ticket</button>
      <div class="next">الرقم التالي: <b><span id="nextNum">—</span></b></div>
      <div class="err" id="err"></div>
    </form>
  </div>

  <!-- قالب التذكرة (يُستخدم عند الطباعة فقط) -->
  <div id="ticket" style="display:none">
    <div id="tTitle">Cardiac Pharmacy Ticket</div>
    <div id="tHello">مرحبًا</div>
    
    <div id="tSub">رقمك هو</div>
    <div id="tNum">-</div>
    <div id="tMrn"></div>
    <div id="tWait"></div>
    <div id="tLine"></div>
    <div id="tThanks">شكرًا لانتظارك</div>
    <div id="tTs"></div>
  </div>

<script>
(function(){
  // ===== Firebase =====
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac_demo"; // غيّرها إذا أردت

  const f=document.getElementById('f');
  const mrnInput=document.getElementById('mrn');
  const err=document.getElementById('err');
  const nextNumEl=document.getElementById('nextNum');

  // أرقام عربية للنص
  const dMap=["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"];
  const toAr=n=>(""+n).replace(/\d/g,d=>dMap[+d]);

  function waitingArabic(n){
    if(n<=0) return "لا أحد أمامك في الانتظار";
    if(n===1) return "أمامك ١ شخص في الانتظار";
    if(n===2) return "أمامك شخصان في الانتظار";
    return `أمامك ${toAr(n)} أشخاص في الانتظار`;
  }

  function validMRN(v){return /^[0-9]{3,}$/.test((v||"").trim());}

  async function getNextNumber(){
    const snap=await db.ref(`${ROOT}/printed`).get();
    const printed=snap.val()||{};
    let max=0;
    for(const k in printed){const n=parseInt(k,10); if(!isNaN(n)&&n>max) max=n;}
    let next=max?max+1:1;
    if(next>1000) next=1;
    return next;
  }

  async function refreshNext(){
    const n=await getNextNumber();
    nextNumEl.textContent=n;
  }

  async function countWaitingBefore(current){
    const [pSnap,sSnap]=await Promise.all([
      db.ref(`${ROOT}/printed`).get(),
      db.ref(`${ROOT}/served`).get()
    ]);
    const printed=pSnap.val()||{};
    const served=sSnap.val()||{};
    let c=0;
    for(const k in printed){
      const n=parseInt(k,10);
      if(!isNaN(n)&&n<current&&!served[n]) c++;
    }
    return c;
  }

  // طباعة من نفس الصفحة لتجنّب حظر النوافذ
  function doPrint(){
    // مهلة قصيرة تسمح للمحرّك بتطبيق @media print
    setTimeout(()=>{ window.print(); }, 50);
  }

  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    err.textContent='';
    const mrn=mrnInput.value.trim();
    if(!validMRN(mrn)){ err.textContent="فضلاً أدخل MRN صحيحًا."; return; }

    const num=await getNextNumber();
    const waiting=await countWaitingBefore(num);

    // سجّل مطبوع وMRN
    await Promise.all([
      db.ref(`${ROOT}/printed/${num}`).set(true),
      db.ref(`${ROOT}/mrn/${num}`).set(mrn),
      db.ref(`${ROOT}/latestPrinted`).set({number:num,mrn,ts:Date.now()})
    ]);

    // جهّز محتوى التذكرة
    document.getElementById('tNum').textContent=num;
    document.getElementById('tMrn').textContent=`رقم الملف: ${mrn}`;
    document.getElementById('tWait').textContent=waitingArabic(waiting);
    const now=new Date();
    const dateStr=now.toLocaleDateString('en-US');
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).replace(' ', '');
document.getElementById('tTs').textContent = `${timeStr} , ${dateStr}`;

    // اطبع
    doPrint();

    // صفّر وحدث التالي
    mrnInput.value='';
    refreshNext();
  });

  // تهيئة
  mrnInput.focus();
  refreshNext();
  db.ref(`${ROOT}/printed`).on('value', refreshNext);
})();
</script>
</body>
</html>
