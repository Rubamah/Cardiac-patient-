<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>كيـوسك التذاكر - Cardiac</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#6b7280; --blue:#2563eb; --shadow:0 12px 34px rgba(0,0,0,.06);
      --error:#dc2626; --panel:#ffffff; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Noto Naskh Arabic UI", "Noto Kufi Arabic", Tahoma, sans-serif;
      display:flex; min-height:100vh;
    }
    .wrap{flex:1; display:flex; align-items:center; justify-content:center; padding:2vh 2vw;}
    .card{width:min(980px,96vw); background:var(--panel); border-radius:20px; box-shadow:var(--shadow);
      padding:3vh 3vw; text-align:center;}
    .topbar{display:flex; justify-content:flex-end; align-items:center; gap:.5rem; margin-bottom:1rem;}
    .langBtn{border:1px solid var(--line); background:#f8fafc; color:#0f172a; padding:.6rem .9rem;
      border-radius:10px; cursor:pointer; font-weight:800;}
    .langBtn.active{background:#0f172a; color:#fff; border-color:#0f172a;}
    .welcome{font-weight:900; font-size:clamp(42px,9vw,92px); letter-spacing:.5px; margin:1vh 0 .4vh;}
    .subtitle{font-size:clamp(18px,3.6vw,28px); color:#1f2937; margin:0 0 3vh;}
    form{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;
      margin:0 auto; max-width:720px;}
    input[type="text"]{
      width:100%; padding:18px; border:2px solid #e5e7eb; border-radius:14px; outline:none;
      font-size:clamp(22px,4.2vw,28px); text-align:center; background:#fff; color:#0f172a;
    }
    input[type="text"]:focus{border-color:#93c5fd; box-shadow:0 0 0 4px #dbeafe;}
    .btn{border:0; border-radius:14px; padding:14px 22px; cursor:pointer; font-weight:900;
      background:var(--blue); color:#fff; font-size:clamp(18px,3.8vw,22px);}
    .error{color:var(--error); font-size:clamp(14px,3.2vw,16px); min-height:22px; margin-top:8px;}
    .nextWrap{margin-top:14px; color:var(--muted); font-size:clamp(14px,3.2vw,16px)}
    .nextNum{font-weight:800; color:#111;}

    /* ===== Print ticket template ===== */
    @media print{
      @page{size:80mm auto; margin:0;}
      html,body{background:#fff}
      body>*{display:none !important;}
      #ticket{display:block !important; width:100%; margin:0; padding:12px 10px; text-align:center; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Naskh Arabic UI", "Noto Kufi Arabic", Tahoma, sans-serif;}
      /* Paper styling */
      #ticket .paper{
        width:100%;
        border-radius:6px;
        padding:4px 0 8px;
      }
      #ticket .welcome{
        font-weight:900;
        font-size:18pt;
        margin:4px 0 2px;
      }
      #ticket .sub{
        font-size:12pt;
        margin:0 0 2px;
      }
      #ticket .bigNum{
        font-weight:900;
        font-size:56pt;
        line-height:1;
        margin:4px 0 0;
      }
      #ticket .mrn{
        font-size:18pt;
        margin:2px 0 2px;
      }
      #ticket .ts{
        font-size:12pt;
        margin:4px 0;
      }
      #ticket .thanks{
        font-size:16pt;
        margin:4px 0 2px;
      }
      #ticket .line{height:2px; background:#000; margin:6px 0;}
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button id="btnAr" class="langBtn active">العربية</button>
        <button id="btnEn" class="langBtn">English</button>
      </div>
      <div class="welcome" id="welcome">مرحباً</div>
      <div class="subtitle" id="subtitle">يرجى إدخال رقم الملف الطبي (MRN)</div>
      <form id="kioskForm">
        <input id="mrn" type="text" inputmode="numeric" autocomplete="off" placeholder="MRN">
        <button class="btn" type="submit" id="printBtn">طباعة التذكرة</button>
      </form>
      <div id="err" class="error"></div>
      <div class="nextWrap" id="nextWrap">
        <span id="nextLabel">الرقم التالي:</span> <span id="next" class="nextNum">1</span>
      </div>
    </div>
  </div>

  <!-- Printable ticket -->
  <div id="ticket" style="display:none">
    <div class="paper">
      <div class="welcome" id="tWelcome">Welcome</div>
      <div class="sub" id="tSub">Your queuing number</div>
      <div class="bigNum" id="tNum">1</div>
      <div class="mrn" id="tMrn">6754</div>
      <div class="ts" id="tTs">2023‑08‑07 18:30</div>
      <div class="line"></div>
      <div class="thanks" id="tThanks">Thank you for waiting</div>
    </div>
  </div>

<script>
(function(){
  const STR={
    ar:{welcome:"مرحباً",subtitle:"يرجى إدخال رقم الملف الطبي (MRN)",placeholder:"MRN",print:"طباعة التذكرة",nextLabel:"الرقم التالي:",err:"Please enter valid MRN",
        tWelcome:"مرحباً", tSub:"رقم دورك", tThanks:"شكراً لانتظارك"},
    en:{welcome:"Welcome",subtitle:"Please write your MRN",placeholder:"MRN",print:"Print Ticket",nextLabel:"Next number:",err:"Please enter valid MRN",
        tWelcome:"Welcome", tSub:"Your queuing number", tThanks:"Thank you for waiting"}
  };
  let lang=localStorage.getItem("kiosk_lang")||"ar";
  const $=id=>document.getElementById(id);
  const el={btnAr:$("btnAr"),btnEn:$("btnEn"),welcome:$("welcome"),subtitle:$("subtitle"),mrn:$("mrn"),printBtn:$("printBtn"),err:$("err"),next:$("next"),nextLabel:$("nextLabel")};
  const tl={tWelcome:$("tWelcome"),tSub:$("tSub"),tNum:$("tNum"),tMrn:$("tMrn"),tTs:$("tTs"),tThanks:$("tThanks")};

  function applyLang(){
    const S=STR[lang];
    document.documentElement.lang=lang;
    document.documentElement.dir=(lang==="ar")?"rtl":"ltr";
    el.btnAr.classList.toggle("active",lang==="ar");
    el.btnEn.classList.toggle("active",lang==="en");
    el.welcome.textContent=S.welcome;
    el.subtitle.textContent=S.subtitle;
    el.mrn.placeholder=S.placeholder;
    el.printBtn.textContent=S.print;
    el.nextLabel.textContent=S.nextLabel;
    tl.tWelcome.textContent=S.tWelcome;
    tl.tSub.textContent=S.tSub;
    tl.tThanks.textContent=S.tThanks;
  }
  $("btnAr").onclick=()=>{lang="ar";localStorage.setItem("kiosk_lang",lang);applyLang();};
  $("btnEn").onclick=()=>{lang="en";localStorage.setItem("kiosk_lang",lang);applyLang();};
  applyLang();

  // Firebase
  const firebaseConfig={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(firebaseConfig);
  const db=firebase.database();
  const ROOT="cardiac_demo_v3",COUNTER=ROOT+"/kioskCounter",TICKETS=ROOT+"/tickets",NUMBERS=ROOT+"/numbers";

  db.ref(COUNTER).on("value",s=>{const v=s.val()||0;el.next.textContent=v?((v%1000)+1):1;});
  function validMRN(v){return /^[0-9]{4,}$/.test(v);}
  function showError(m){el.err.textContent=m||"";}
  function nextNumber(){return new Promise((res,rej)=>{
    const r=db.ref(COUNTER);
    r.transaction(c=>{let v=(typeof c==="number"?c:0)+1; if(v>1000) v=1; return v;},
      (e,ok,s)=>{ if(e||!ok){rej(e||new Error("fail"));return;} res(s.val()); });
  });}

  $("kioskForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const mrn=(el.mrn.value||"").trim();
    if(!validMRN(mrn)){showError(STR[lang].err); el.mrn.focus(); return;}
    showError("");
    try{
      const n=await nextNumber();
      await db.ref(TICKETS+"/"+n).set({number:n,mrn,createdAt:Date.now()});
      await db.ref(NUMBERS+"/"+n).set("printed");

      // Fill template
      tl.tNum.textContent=n;
      tl.tMrn.textContent=mrn;
      tl.tTs.textContent=new Date().toLocaleString(lang==="ar"?"ar-SA":"en-US");

      // Print
      setTimeout(()=>window.print(),50);
      setTimeout(()=>{el.mrn.value=""; el.mrn.focus();},200);
    }catch(err){console.error(err); showError(lang==="ar"?"تعذر إصدار التذكرة":"Could not issue ticket");}
  });

  window.onload=()=>el.mrn.focus();
})();
</script>
</body>
</html>
