<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Cardiac Pharmacy Tickets</title>

<style>
  body {
    font-family: "Tahoma","Segoe UI","Arial",sans-serif;
    background:#f8fafc;
    margin:0;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    height:100vh;
    text-align:center;
    direction:rtl;
  }

  h1 {
    font-size:36px;
    margin-bottom:10px;
    color:#111;
  }

  h2 {
    font-size:18px;
    color:#444;
    margin-top:0;
    margin-bottom:30px;
  }

  input[type="number"] {
    font-size:20px;
    padding:10px 15px;
    border:2px solid #ccc;
    border-radius:10px;
    width:220px;
    text-align:center;
    margin-bottom:20px;
  }

  button {
    font-size:22px;
    padding:14px 28px;
    background:#007bff;
    color:#fff;
    border:none;
    border-radius:10px;
    cursor:pointer;
  }

  button:hover { background:#0056b3; }

  #err {
    margin-top:12px;
    font-size:16px;
    color:#e11d48;
    min-height:24px;
  }

  #nextNum {
    font-size:18px;
    color:#444;
    margin-top:15px;
  }

  /* تذكرة الطباعة */
  @media print {
    @page {
      size: 80mm auto;   /* العرض ثابت، الطول تلقائي */
      margin: 0;
    }

    body > * { display: none !important; }

    #ticket {
      display: block !important;
      width: 100%;
      padding: 10mm 6mm;
      font-family: "Tahoma", "Segoe UI", "Arial", sans-serif;
      direction: rtl;
      text-align: center;
    }

    #tTitle {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 16pt;
      margin: 0 0 6mm;
    }

    #tHello {
      display: block;
      width: 100%;
      font-size: 30pt;
      line-height: 1.1;
      margin: 0 0 4mm;
    }

    #tSub {
      display: block;
      width: 100%;
      font-size: 16pt;
      line-height: 1.2;
      margin: 0 0 6mm;
    }

    #tNum {
      display: block;
      width: 100%;
      font-size: 56pt;
      line-height: 1.0;
      margin: 0 0 6mm;
    }

    #tMrn {
      display: block;
      width: 100%;
      font-size: 14pt;
      margin: 0 0 3mm;
    }

    #tWait {
      display: block;
      width: 100%;
      font-size: 13pt;
      margin: 0 0 5mm;
    }

    #tLine {
      height: 2px;
      background: #000;
      margin: 3mm 0;
    }

    #tThanks {
      display: block;
      width: 100%;
      font-size: 20pt;
      margin: 2mm 0 3mm;
    }

    #tTs {
      display: block;
      width: 100%;
      font-size: 11pt;
      margin: 0;
    }
  }
</style>
</head>
<body>

  <h1>مرحبًا</h1>
  <h2>الرجاء إدخال رقم الملف (MRN)</h2>

  <input id="mrn" type="number" placeholder="رقم الملف" inputmode="numeric" />

  <button id="printBtn">طباعة التذكرة / Print Ticket</button>
  <div id="err"></div>
  <div id="nextNum">الرقم التالي: <span id="nxt">1</span></div>

  <!-- قالب التذكرة -->
  <div id="ticket" style="display:none;">
    <div id="tTitle">Cardiac Pharmacy Ticket</div>
    <div id="tHello">مرحبًا</div>
    <div id="tSub">رقم الانتظار</div>
    <div id="tNum"></div>
    <div id="tMrn"></div>
    <div id="tWait"></div>
    <div id="tLine"></div>
    <div id="tThanks">شكرًا لانتظارك</div>
    <div id="tTs"></div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
(function(){
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac_demo";

  const mrn=document.getElementById("mrn");
  const err=document.getElementById("err");
  const nxt=document.getElementById("nxt");
  const tNum=document.getElementById("tNum");
  const tMrn=document.getElementById("tMrn");
  const tWait=document.getElementById("tWait");
  const tTs=document.getElementById("tTs");

  db.ref(`${ROOT}/latestPrinted`).on("value",s=>{
    nxt.textContent=s.val()||1;
  });

  document.getElementById("printBtn").onclick=async()=>{
    const val=mrn.value.trim();
    if(!/^[0-9]{4,}$/.test(val)){
      err.textContent="فضلاً أدخل MRN صحيحًا";
      return;
    }
    err.textContent="";

    const snap=await db.ref(`${ROOT}/latestPrinted`).get();
    let n=snap.exists()?snap.val()+1:1;
    if(n>1000) n=1;

    await db.ref(`${ROOT}/printed/${n}`).set(true);
    await db.ref(`${ROOT}/mrn/${n}`).set(val);
    await db.ref(`${ROOT}/latestPrinted`).set(n);

    const allPrinted=await db.ref(`${ROOT}/printed`).get();
    const allServed=await db.ref(`${ROOT}/served`).get();
    const printed=allPrinted.val()||{};
    const served=allServed.val()||{};
    const waiting=Object.keys(printed).filter(k=>!served[k]&&k<n).length;

    tNum.textContent=n;
    tMrn.textContent="MRN: "+val;

    let waitText="";
    if(waiting===0) waitText="لا يوجد أحد أمامك";
    else if(waiting===1) waitText="أمامك شخص واحد";
    else if(waiting===2) waitText="أمامك شخصان";
    else waitText=`أمامك ${waiting} أشخاص`;
    tWait.textContent=waitText;

    const ts=new Date();
    const date=ts.toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});
    const time=ts.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:true});
    tTs.textContent=`${date}  ${time}`;

    document.getElementById("ticket").style.display="block";
    window.print();
    document.getElementById("ticket").style.display="none";
  };
})();
</script>
</body>
</html>
