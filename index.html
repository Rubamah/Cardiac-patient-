<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Kiosk</title>

<style>
  :root{
    --blue:#2563eb; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --panel:#ffffff; --bg:#f5f7fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--ink); display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:min(960px,92vw); padding:24px 20px}
  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:20px;
    padding:28px 22px; box-shadow:0 10px 28px rgba(2,8,23,.06); text-align:center;
  }
  h1{margin:10px 0 6px; font-size:clamp(42px,7.2vw,68px); font-weight:900}
  .sub{margin:0 0 20px; color:var(--muted); font-size:clamp(18px,3.4vw,26px)}
  form{display:flex; flex-direction:column; gap:14px; align-items:center}
  label{width:100%; max-width:640px; color:var(--muted); font-weight:700; text-align:center; font-size:20px}
  .row{width:100%; max-width:640px}
  input{
    width:100%; padding:16px 14px; border-radius:14px; border:2px solid #c7d2fe;
    font-size:20px; text-align:center; outline:none
  }
  input:focus{border-color:#93c5fd}
  .btn{
    background:var(--blue); color:#fff; border:0; border-radius:14px;
    padding:14px 22px; font-weight:900; font-size:22px; cursor:pointer;
    width:100%; max-width:640px
  }
  .hint{margin-top:10px; color:#64748b; font-size:15px; text-align:center; opacity:.9}
  .nextLabel{margin-top:8px; color:var(--muted); font-weight:700; text-align:center; font-size:20px}
  .err{min-height:22px; color:#dc2626; font-weight:700; text-align:center; margin-top:4px}

  /* --------- PRINT: English-only for Epson TM-T20 (80mm x 90mm) ---------- */
  @media print{
    @page{ size:80mm 90mm; margin:0 } /* fixed 90mm height */
    body>*{ display:none !important }

    #ticket{
      display:block !important;
      width:100%;
      height:90mm;
      padding:6mm 6mm;
      text-align:center;
      font-family:"Consolas","Courier New",monospace;
      -webkit-print-color-adjust:exact; print-color-adjust:exact;
    }
    #tHead   { font-size:12pt; font-weight:bold; margin:0 0 4px }
    #tTitle  { font-size:18pt; font-weight:900; margin:3mm 0 3mm; text-align:center; }
    #tNum    { font-size:50pt; font-weight:900; line-height:1; margin:6px 0 }
    #tMrn    { font-size:11pt; margin:2mm 0 }
    #tWait   { font-size:10pt; margin:2mm 0 }
    #tTs     { font-size:10pt; margin:2mm 0 }
    #tThanks { font-size:12pt; margin-top:3mm }
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>مرحبًا</h1>
      <p class="sub">فضلاً اكتب رقم الملف (MRN)</p>

      <form id="frm">
        <div class="row">
          <label for="mrn">رقم الملف (MRN)</label>
          <input id="mrn" inputmode="numeric" autocomplete="off" placeholder="MRN" />
        </div>

        <button class="btn" id="btnPrint" type="submit">طباعة التذكرة / Print Ticket</button>

        <div class="nextLabel">الرقم التالي: <span id="nextNum">-</span></div>
        <div class="hint">سيتم طباعة التذكرة تلقائيًا، الرجاء الانتظار.</div>
        <div class="err" id="err"></div>
      </form>
    </div>
  </div>

  <!-- PRINT CONTENT (English-only) -->
  <div id="ticket" style="display:none">
    <div id="tHead">Cardiac Pharmacy Ticket</div>
    <div id="tTitle">Queue Number</div>
    <div id="tNum">-</div>
    <div id="tMrn"></div>
    <div id="tWait"></div>
    <div id="tTs"></div>
    <div id="tThanks">Thank you for waiting</div>
  </div>

<script>
(function(){
  // Firebase config
  const cfg={
    apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
    authDomain:"q-matic-b7d77.firebaseapp.com",
    databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
    projectId:"q-matic-b7d77",
    storageBucket:"q-matic-b7d77.appspot.com",
    messagingSenderId:"908187704899",
    appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
  };
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac_demo";   // ← غيّريها إلى "cardiac" للنسخة النهائية

  const nextEl = document.getElementById('nextNum');
  const errEl  = document.getElementById('err');
  const mrnEl  = document.getElementById('mrn');

  db.ref(`${ROOT}/next`).on('value', s=>{
    const n = s.val() || 1;
    nextEl.textContent = n;
  });

  async function getWaitingCount(){
    const p = (await db.ref(`${ROOT}/printed`).get()).val() || {};
    const sv = (await db.ref(`${ROOT}/served`).get()).val() || {};
    let count = 0;
    for(const k in p){ if(p[k] && !sv[k]) count++; }
    return count;
  }

  function validMrn(v){
    if(!v) return true;
    return /^\d{4,}$/.test(v.trim());
  }

  document.getElementById('frm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    errEl.textContent = "";

    const mrnRaw = (mrnEl.value || "").trim();
    if(!validMrn(mrnRaw)){
      errEl.textContent = "فضلاً أدخل رقم الملف بشكل صحيح.";
      mrnEl.focus(); return;
    }

    const snap = await db.ref(`${ROOT}/next`).get();
    let n = snap.exists() ? snap.val() : 1;

    document.getElementById('tNum').textContent  = n;
    document.getElementById('tMrn').textContent  = mrnRaw ? `MRN: ${mrnRaw}` : "";
    document.getElementById('tWait').textContent = `No. of people waiting: ${await getWaitingCount()}`;
    document.getElementById('tTs').textContent   = new Date().toLocaleString('en-GB', { hour12:false });

    const updates = {};
    updates[`${ROOT}/printed/${n}`] = true;
    if(mrnRaw) updates[`${ROOT}/mrn/${n}`] = mrnRaw;
    const nextVal = (n >= 1000) ? 1 : n+1;
    updates[`${ROOT}/next`] = nextVal;
    await db.ref().update(updates);

    setTimeout(()=>window.print(), 40);

    mrnEl.value = "";
    mrnEl.blur();
    setTimeout(()=>mrnEl.focus(), 300);
  });
})();
</script>
</body>
</html>
